<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Portal | GEOID STUDY CENTRE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-deep: #1a2a6c;
            --accent-gold: #fdbb2d;
            --sidebar-bg: #ffffff;
            --text-dark: #2d3436;
            --grid-color: #2980b9;
            --shadow-3d: 6px 6px 12px rgba(0, 0, 0, 0.45), inset -2px -2px 4px rgba(0,0,0,0.2);
        }

        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #e9ecef; }
        .banner-container { width: 100%; background: white; text-align: center; border-bottom: 3px solid var(--primary-deep); }
        .banner-container img { max-width: 550px; width: 100%; height: auto; }
        
        .portal-main { display: flex; min-height: calc(100vh - 110px); }
        .sidebar { width: 240px; background: var(--sidebar-bg); border-right: 1px solid #ddd; }
        .profile-area { padding: 25px 10px; text-align: center; border-bottom: 1px solid #eee; }
        .profile-area img { width: 85px; height: 95px; border: 2px solid var(--primary-deep); object-fit: cover; border-radius: 4px; }
        .profile-area h4 { margin: 12px 0 5px; color: var(--primary-deep); font-size: 14px; text-transform: uppercase; }
        
        .menu-label { background: var(--primary-deep); color: white; padding: 8px 15px; font-size: 11px; font-weight: bold; }
        .nav-list { list-style: none; padding: 0; margin: 0; }
        .nav-list li { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 12.5px; color: var(--text-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .nav-list li:hover { background: #f8f9fa; color: var(--grid-color); }

        .content-area { flex: 1; padding: 30px; background-color: #f1f3f5; }
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; max-width: 1100px; margin: 0 auto; }
        
        .grid-box { 
            background: var(--grid-color); color: white; text-decoration: none; 
            padding: 15px 10px; border-radius: 10px; text-align: center; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            gap: 8px; font-weight: bold; font-size: 11px; box-shadow: var(--shadow-3d); height: 100px; 
            transition: 0.3s ease;
        }
        .grid-box:hover { transform: translateY(-5px); filter: brightness(1.1); }
        .grid-box i { font-size: 24px; color: var(--accent-gold); }

        .auth-card { max-width: 400px; margin: 50px auto; background: white; padding: 35px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center; }
        .form-input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn-submit { background: var(--primary-deep); color: white; border: none; width: 100%; padding: 12px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 10px; }

        footer { padding: 15px; text-align: center; background: white; font-size: 11px; color: #777; border-top: 1px solid #ddd; position: relative; bottom: 0; width: 100%; box-sizing: border-box; }
        .hidden { display: none; }
        @media (max-width: 900px) { .grid-container { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="banner-container">
    <img src="https://ik.imagekit.io/8v5m0fw9z/Blue%20and%20White%20Modern%20Coming%20Soon%20Email%20Header.png" alt="GEOID Banner">
</div>

<div id="auth-section">
    <div id="login-view" class="auth-card">
        <h3 style="color:var(--primary-deep); margin-bottom:20px;">STUDENT LOGIN</h3>
        <form id="login-form">
            <input type="email" id="login-email" class="form-input" placeholder="Email Address" required>
            <input type="password" id="login-password" class="form-input" placeholder="Password" required>
            <button type="submit" class="btn-submit">LOGIN</button>
        </form>
        <p style="font-size:12px; margin-top:15px;">New User? <a href="#" onclick="toggleAuth()" style="color:red; font-weight:bold;">Register Here</a></p>
    </div>

    <div id="signup-view" class="auth-card hidden">
        <h3 style="color:var(--primary-deep); margin-bottom:20px;">REGISTRATION</h3>
        <form id="signup-form">
            <input type="text" id="signup-name" class="form-input" placeholder="Full Name" required>
            <input type="email" id="signup-email" class="form-input" placeholder="Email Address" required>
            <input type="password" id="signup-password" class="form-input" placeholder="Password" required>
            <p style="text-align:left; font-size:10px; color:gray; margin:5px 0 0;">Upload Profile Photo:</p>
            <input type="file" id="signup-photo" class="form-input" accept="image/*">
            <button type="submit" class="btn-submit">CREATE ACCOUNT</button>
        </form>
        <p><a href="#" onclick="toggleAuth()" style="font-weight:bold; color:var(--grid-color); font-size:12px;">Back to Login</a></p>
    </div>
</div>

<div id="dashboard-view" class="hidden portal-main">
    <div class="sidebar">
        <div class="profile-area">
            <img id="d-photo" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Student">
            <h4 id="d-name">STUDENT NAME</h4>
        </div>
        <div class="menu-label">Portal Resources</div>
        <ul class="nav-list">
            <li><i class="fas fa-user-edit"></i> Edit Profile</li>
            <li onclick="logout()" style="color:red; font-weight:bold;"><i class="fas fa-sign-out-alt"></i> Logout</li>
        </ul>
    </div>

    <div class="content-area">
        <div class="grid-container">
            <a href="#" id="link-tutorial" class="grid-box"><i class="fas fa-book-open"></i><span>DAILY TUTORIAL</span></a>
            <a href="#" id="link-qbank" class="grid-box"><i class="fas fa-layer-group"></i><span>QUESTION BANK</span></a>
            <a href="#" id="link-mcq" class="grid-box"><i class="fas fa-pencil-alt"></i><span>MCQ PRACTICE</span></a>
            <a href="#" id="link-test" class="grid-box"><i class="fas fa-file-alt"></i><span>WEEKLY TEST</span></a>
            <a href="#" id="link-assignment" class="grid-box"><i class="fas fa-tasks"></i><span>ASSIGNMENT</span></a>
            <a href="#" id="link-notice" class="grid-box"><i class="fas fa-bullhorn"></i><span>NOTICE</span></a>
            <a href="#" id="link-fees" class="grid-box"><i class="fas fa-rupee-sign"></i><span>FEES</span></a>
            <a href="#" id="link-result" class="grid-box"><i class="fas fa-chart-line"></i><span>RESULT</span></a>
        </div>
    </div>
</div>

<footer>
    Â© 2026 GEOID Study Centre | Developed by <span style="color:var(--primary-deep); font-weight:bold;">Subhadip Cyber Technology</span>
</footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
    // --- SUPABASE CONFIGURATION ---
    const supabaseUrl = "https://vthljyiepifevycrglbb.supabase.co";
    const supabaseKey = "sb_publishable_YSDbjlGYZ1-Y33Og2VD0PQ_BYRcrzhM";
    const sb = supabase.createClient(supabaseUrl, supabaseKey);

    function toggleAuth(){
        document.getElementById("login-view").classList.toggle("hidden");
        document.getElementById("signup-view").classList.toggle("hidden");
    }

    // --- DASHBOARD LOADER ---
    async function showDashboard(user) {
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("dashboard-view").classList.remove("hidden");

        // Fetch profile data from 'profiles' table
        const { data: profile } = await sb
            .from('profiles')
            .select('full_name, avatar_url')
            .eq('id', user.id)
            .single();

        if (profile) {
            document.getElementById("d-name").innerText = profile.full_name;
            if (profile.avatar_url) document.getElementById("d-photo").src = profile.avatar_url;
        }

        // Fetch dynamic content from 'student_contents' table
        loadStudentContents(user.email);
    }

    async function loadStudentContents(email) {
        const { data: contents, error } = await sb
            .from('student_contents')
            .select('id, student_email, content_type, file_url, title')
            .eq('student_email', email);

        if (contents) {
            contents.forEach(item => {
                const boxId = `link-${item.content_type.toLowerCase().trim()}`;
                const boxElement = document.getElementById(boxId);
                if (boxElement) {
                    boxElement.href = item.file_url;
                    boxElement.target = "_blank";
                    boxElement.querySelector('span').innerText = item.title;
                    boxElement.style.background = "#2ecc71"; // Success Green
                    boxElement.style.boxShadow = "0 5px 15px rgba(46, 204, 113, 0.4)";
                }
            });
        }
    }

    // --- AUTHENTICATION HANDLERS ---
    (async () => {
        const { data: { user } } = await sb.auth.getUser();
        if (user) showDashboard(user);
    })();

    document.getElementById("login-form").addEventListener("submit", async e => {
        e.preventDefault();
        const { data, error } = await sb.auth.signInWithPassword({
            email: document.getElementById("login-email").value,
            password: document.getElementById("login-password").value
        });
        if (error) alert("Login Failed: " + error.message);
        else showDashboard(data.user);
    });

    document.getElementById("signup-form").addEventListener("submit", async e => {
        e.preventDefault();
        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;
        const name = document.getElementById("signup-name").value;
        const photoFile = document.getElementById("signup-photo").files[0];

        // 1. Create Auth User
        const { data: authData, error: authError } = await sb.auth.signUp({ email, password });
        if (authError) return alert("Signup Error: " + authError.message);

        // 2. Handle Photo Upload to 'avatars' bucket
        let photoUrl = "";
        if (photoFile && authData.user) {
            const fileName = `avatar_${authData.user.id}_${Date.now()}`;
            const { data: uploadData } = await sb.storage.from('avatars').upload(fileName, photoFile);
            if (uploadData) {
                photoUrl = sb.storage.from('avatars').getPublicUrl(fileName).data.publicUrl;
            }
        }

        // 3. Insert into 'profiles' table
        if (authData.user) {
            await sb.from('profiles').insert([{ 
                id: authData.user.id, 
                full_name: name, 
                avatar_url: photoUrl 
            }]);
            alert("Account created successfully! Please login.");
            location.reload();
        }
    });

    async function logout() {
        await sb.auth.signOut();
        location.reload();
    }
</script>
</body>
</html>
